package edu.mit.mitmobile2.events;

import java.text.SimpleDateFormat;
import java.util.Date;

import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.view.Menu;

import edu.mit.mitmobile2.MobileWebApi;
import edu.mit.mitmobile2.Module;
import edu.mit.mitmobile2.R;
import edu.mit.mitmobile2.SliderActivity;
import edu.mit.mitmobile2.events.EventsModel.EventType;

public class MITEventsDaysSliderActivity extends SliderActivity {
	
	final static String LIST_TYPE_KEY = "list_type";
	final static int STANDARD_LIST = 0;
	final static int LIST_BY_CATEGORY = 1;
	
	final static String CATEGORY_ID_KEY = "category_id";
	final static String CATEGORY_NAME_KEY = "category_name";
	final static String START_TIME_KEY = "start_time";
	
	final static String EVENT_TYPE_KEY = "event_type";
	final static int EVENT_TYPE_EVENTS = 0;
	final static int EVENT_TYPE_EXHIBITS = 1;
	final static int DAYS_PAST_FUTURE = 30;
	
	private static final long TWENTY_FOUR_HOURS = 24 * 60 *  60 * 1000;
	
	private long mCurrentTime = System.currentTimeMillis();
	private long mStartTime;
	
	private SimpleDateFormat sDateFormat = new SimpleDateFormat("MMMM d");
	
	private EventType mEventType = null;
	
	private int mCategoryId = -1;
	private String mCategoryName = null;
	
	public static void launch(Context context, EventType eventType) {	
		launchEventType(context, eventType.getTypeId(), null);
	}
	
	public static void launchEventType(Context context, String eventType, Long startTime) {	
		Intent intent = new Intent(context, MITEventsDaysSliderActivity.class);
		intent.putExtra(EVENT_TYPE_KEY, eventType);
		intent.putExtra(LIST_TYPE_KEY, STANDARD_LIST);
		if(startTime != null) {
			intent.putExtra(START_TIME_KEY, startTime);
		}
		context.startActivity(intent);
	}
	
	public static void launchCategory(Context context, int categoryId, String categoryName, String eventType, Long startTime) {	
		Intent intent = new Intent(context, MITEventsDaysSliderActivity.class);
		intent.putExtra(LIST_TYPE_KEY, LIST_BY_CATEGORY);
		intent.putExtra(CATEGORY_ID_KEY, categoryId);
		intent.putExtra(CATEGORY_NAME_KEY, categoryName);
		intent.putExtra(EVENT_TYPE_KEY, eventType);
		if(startTime != null) {
			intent.putExtra(START_TIME_KEY, startTime);
		}
		context.startActivity(intent);
	}
	
	
	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		
		final Bundle extras = getIntent().getExtras();
		
		setJumpTitle("Go to Date", R.drawable.menu_go_to_date);
		
		mStartTime = extras.getLong(START_TIME_KEY, System.currentTimeMillis());
		if(extras.getInt(LIST_TYPE_KEY) == LIST_BY_CATEGORY) {
			mCategoryId = extras.getInt(CATEGORY_ID_KEY);
			mCategoryName = extras.getString(CATEGORY_NAME_KEY);
		}
		
		if(EventsModel.eventTypesLoaded()) {
			mEventType = EventsModel.getEventType(extras.getString(EVENT_TYPE_KEY));
			createViews();
		} else {
			// need to load the event types
			showLoading("Events");
			EventsModel.fetchEventTypes(this, new Handler() {
				@Override
				public void handleMessage(Message msg) {
					if(msg.arg1 == MobileWebApi.SUCCESS) {
						mEventType = EventsModel.getEventType(extras.getString(EVENT_TYPE_KEY));
						showLoadingCompleted();
						createViews();
					} else {
						showLoadingError();
					}
				}
			});
		}
	}
	
	protected void createViews() {
		if(mCategoryName != null) {
			useSubtitles(mCategoryName);
		} else if(mEventType != null) {
			useSubtitles(mEventType.getShortName());
		}
		
		// calculate today, tommorrow, and yesterday
		String today = sDateFormat.format(new Date(mCurrentTime));
		String tomorrow = sDateFormat.format(new Date(mCurrentTime + TWENTY_FOUR_HOURS));
		String yesterday = sDateFormat.format(new Date(mCurrentTime - TWENTY_FOUR_HOURS));
		
		// create views for today, and a fixed number of days in the past and future
		for(long i = -DAYS_PAST_FUTURE; i <= DAYS_PAST_FUTURE; i++) {
			long dayTime = mStartTime + i * TWENTY_FOUR_HOURS;
			
			EventsListSliderInterface sliderInterface = null;
			if(mCategoryId < 0) {
				sliderInterface	= EventsListSliderInterface.daysFactory(this, mEventType, dayTime/1000);
			} else {
				sliderInterface = EventsListSliderInterface.categoriesFactory(this, mCategoryId, mEventType, dayTime/1000);
			} 
			
			String dayTitle = sDateFormat.format(new Date(dayTime));
			if(dayTitle.equals(today)) {
				dayTitle = "Today";
			} else if(dayTitle.equals(tomorrow)) {
				dayTitle = "Tomorrow";
			} else if(dayTitle.equals(yesterday)) {
				dayTitle = "Yesterday";
			}
			
			addScreen(sliderInterface, dayTitle, dayTitle);
		}
		
		// set the position to today
		setPosition(DAYS_PAST_FUTURE);
		
	}
	
	@Override
	protected Module getModule() {
		return new EventsModule();
	}

	@Override
	public boolean isModuleHomeActivity() {
		return false;
	}

	@Override
	protected void prepareActivityOptionsMenu(Menu menu) {
		prepareJumpOptionsMenu(menu);
		
		menu.add(0, MENU_SEARCH, Menu.NONE, MENU_SEARCH_TITLE)
			.setIcon(R.drawable.menu_search);
	}
}
